<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Food Delivery App ¬∑ PaymentFactory Pattern</title>
  <style>
    :root{
      --bg: #0b0c10;
      --card: #111318;
      --muted: #9aa4b2;
      --text: #e6eaf2;
      --brand: #6ee7b7;
      --brand-2: #60a5fa;
      --danger: #ef4444;
      --ring: rgba(110,231,183,.35);
      --shadow: 0 10px 30px rgba(0,0,0,.35);
      --radius: 18px;
    }
    *{box-sizing:border-box}
    body{
      margin:0; font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, "Helvetica Neue", Arial, "Noto Sans", "Apple Color Emoji", "Segoe UI Emoji";
      background: radial-gradient(1200px 800px at 10% -10%, rgba(96,165,250,.15), transparent),
                  radial-gradient(1000px 600px at 90% 10%, rgba(110,231,183,.12), transparent),
                  var(--bg);
      color:var(--text);
      min-height:100dvh; display:grid; place-items:center; padding:28px;
    }
    .app{ width:min(980px, 100%); }
    .header{
      display:flex; align-items:center; justify-content:space-between; gap:16px; margin-bottom:20px;
    }
    .brand{ display:flex; align-items:center; gap:12px; }
    .brand .logo{ width:44px; height:44px; border-radius:12px; display:grid; place-items:center; background:linear-gradient(135deg, var(--brand-2), var(--brand)); box-shadow: var(--shadow); }
    .brand h1{ font-size: clamp(20px, 2.4vw, 28px); margin:0; letter-spacing:.3px; }
    .card{
      background: linear-gradient(180deg, rgba(255,255,255,.02), rgba(255,255,255,.00)), var(--card);
      border:1px solid rgba(255,255,255,.06);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      padding: 22px; backdrop-filter: blur(6px);
    }
    .grid{ display:grid; grid-template-columns: 1.1fr .9fr; gap: 18px; }
    @media (max-width: 840px){ .grid{ grid-template-columns: 1fr; } }

    .section-title{ font-size:14px; text-transform:uppercase; color:var(--muted); letter-spacing:.14em; margin:0 0 12px; }

    label{ display:block; font-size:14px; color:var(--muted); margin:12px 0 6px; }
    input, select{ width:100%; background:#0f1116; color:var(--text); border:1px solid rgba(255,255,255,.08); border-radius:12px; padding:12px 14px; outline:none; transition:.2s ease; }
    input:focus, select:focus{ border-color: var(--brand); box-shadow: 0 0 0 5px var(--ring); }
    .row{ display:grid; grid-template-columns: 1fr 1fr; gap:12px; }

    .btn{
      margin-top:16px; appearance:none; border:none; cursor:pointer; font-weight:600; letter-spacing:.3px;
      padding:12px 16px; border-radius:14px; background:linear-gradient(135deg, var(--brand), var(--brand-2));
      color:#0b1220; box-shadow: 0 6px 20px rgba(96,165,250,.35);
    }
    .btn:disabled{ opacity:.6; cursor:not-allowed; }

    .pill{ display:inline-flex; align-items:center; gap:8px; padding:8px 12px; border-radius:999px; background:#0f1116; border:1px solid rgba(255,255,255,.06); font-size:13px; color:var(--muted); }
    .stack{ display:flex; gap:8px; flex-wrap:wrap; }

    .output{ background:#0a0d12; border:1px dashed rgba(255,255,255,.14); border-radius:14px; padding:16px; font: 12px ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace; white-space:pre-wrap; word-break:break-word; min-height:110px; }

    .error{ color: var(--danger); font-size: 13px; margin-top: 10px; display:none; }

    .footer{ margin-top:14px; color:var(--muted); font-size:12px; text-align:center; }
    .kbd{ font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace; background:#0f1116; border:1px solid rgba(255,255,255,.1); border-radius:8px; padding:2px 6px; }
  </style>
</head>
<body>
  <div class="app">
    <div class="header">
      <div class="brand">
        <div class="logo" aria-hidden="true">üçî</div>
        <h1>Food Delivery ‚Äì PaymentFactory Demo</h1>
      </div>
      <div class="stack">
        <span class="pill">Factory Method</span>
        <span class="pill">UPI</span>
        <span class="pill">Wallet</span>
        <span class="pill">COD</span>
        <span class="pill">Credit Card</span>
      </div>
    </div>

    <div class="grid">
      <section class="card">
        <h2 class="section-title">Checkout</h2>
        <form id="checkout-form">
          <label for="amount">Order Amount (‚Çπ)</label>
          <input id="amount" name="amount" type="number" inputmode="decimal" min="1" step="0.01" placeholder="e.g., 599.00" required />

          <label for="paymentType">Payment Method</label>
          <select id="paymentType" name="paymentType" required>
            <option value="">‚Äî Select ‚Äî</option>
            <option value="upi">UPI</option>
            <option value="wallet">Wallet</option>
            <option value="cod">Cash on Delivery (COD)</option>
            <option value="credit">Credit Card</option>
          </select>

          <!-- Dynamic fields mount here -->
          <div id="dynamic-fields"></div>

          <button class="btn" type="submit">Pay Now</button>
          <div id="form-error" class="error"></div>
        </form>
      </section>

      <section class="card">
        <h2 class="section-title">Result</h2>
        <div id="output" class="output" aria-live="polite"></div>
        <div class="footer">Tip: Open DevTools (<span class="kbd">F12</span>) to see console logs.</div>
      </section>
    </div>
  </div>

  <script>
    /**
     * PaymentFactory ‚Äî Factory Method pattern demo
     * Produces different payment objects for a food delivery checkout.
     */

    // Base Product
    class Payment {
      constructor({ amount }) {
        this.amount = Number(amount);
        if (!(this.amount > 0)) throw new Error("Invalid amount");
      }
      /** @returns {{status: 'success'|'failed', method: string, transactionId?: string, message?: string}} */
      pay() { throw new Error("pay() must be implemented in subclass"); }
    }

    // Concrete Products
    class UpiPayment extends Payment {
      constructor({ amount, upiId }) {
        super({ amount });
        this.upiId = upiId;
      }
      pay() {
        if (!/^\w[\w.\-]{1,}@\w{2,}$/i.test(this.upiId || "")) {
          return { status: 'failed', method: 'UPI', message: 'Invalid UPI ID' };
        }
        return {
          status: 'success',
          method: 'UPI',
          transactionId: createTxn('UPI'),
        };
      }
    }

    class WalletPayment extends Payment {
      constructor({ amount, walletId }) {
        super({ amount });
        this.walletId = walletId;
        this.balance = 1000; // demo wallet balance
      }
      pay() {
        if (!this.walletId || this.walletId.length < 4) {
          return { status: 'failed', method: 'Wallet', message: 'Invalid wallet ID' };
        }
        if (this.amount > this.balance) {
          return { status: 'failed', method: 'Wallet', message: 'Insufficient wallet balance' };
        }
        this.balance -= this.amount;
        return { status: 'success', method: 'Wallet', transactionId: createTxn('WAL') };
      }
    }

    class CodPayment extends Payment {
      pay() {
        // Always allowed in demo, actual app would consider order value & location
        return { status: 'success', method: 'Cash on Delivery', transactionId: createTxn('COD') };
      }
    }

    class CreditCardPayment extends Payment {
      constructor({ amount, cardNumber, nameOnCard, expiry, cvv }) {
        super({ amount });
        this.cardNumber = (cardNumber || '').replace(/\s+/g, '');
        this.nameOnCard = nameOnCard;
        this.expiry = expiry; // MM/YY
        this.cvv = cvv;       // 3 digits (simplified)
      }
      pay() {
        if (!luhn(this.cardNumber)) {
          return { status: 'failed', method: 'Credit Card', message: 'Invalid card number' };
        }
        if (!/^\d{2}\/\d{2}$/.test(this.expiry || '')) {
          return { status: 'failed', method: 'Credit Card', message: 'Invalid expiry (MM/YY)' };
        }
        if (!/^\d{3}$/.test(this.cvv || '')) {
          return { status: 'failed', method: 'Credit Card', message: 'Invalid CVV' };
        }
        if (isExpired(this.expiry)) {
          return { status: 'failed', method: 'Credit Card', message: 'Card expired' };
        }
        return { status: 'success', method: 'Credit Card', transactionId: createTxn('CRD') };
      }
    }

    // The Factory
    class PaymentFactory {
      /** @param {'upi'|'wallet'|'cod'|'credit'} type */
      static create(type, payload) {
        switch (type) {
          case 'upi': return new UpiPayment(payload);
          case 'wallet': return new WalletPayment(payload);
          case 'cod': return new CodPayment(payload);
          case 'credit': return new CreditCardPayment(payload);
          default: throw new Error(Unsupported payment type: ${type});
        }
      }
    }

    // ‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî
    // Utilities
    function createTxn(prefix){
      // Not cryptographically secure ‚Äî just a quick pretty id for demo
      const rand = Math.random().toString(36).slice(2, 8).toUpperCase();
      const ms = Date.now().toString(36).toUpperCase();
      return ${prefix}-${ms}-${rand};
    }
    function isExpired(mmYY){
      const [mm, yy] = mmYY.split('/').map(n => parseInt(n, 10));
      if(!mm || !yy) return true;
      const year = 2000 + yy; // naive conversion
      const lastDay = new Date(year, mm, 0); // last day of month
      const now = new Date();
      // consider card valid through the end of expiry month
      return now > lastDay;
    }
    // Luhn algorithm for card validation
    function luhn(num){
      if(!/^\d{12,19}$/.test(num)) return false;
      let sum = 0; let dbl = false;
      for(let i = num.length - 1; i >= 0; i--){
        let d = parseInt(num[i], 10);
        if(dbl){ d *= 2; if(d > 9) d -= 9; }
        sum += d; dbl = !dbl;
      }
      return sum % 10 === 0;
    }

    // ‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî
    // UI Logic
    const form = document.getElementById('checkout-form');
    const paymentType = document.getElementById('paymentType');
    const dyn = document.getElementById('dynamic-fields');
    const out = document.getElementById('output');
    const err = document.getElementById('form-error');

    paymentType.addEventListener('change', renderDynamicFields);
    form.addEventListener('submit', onSubmit);

    function renderDynamicFields(){
      err.style.display = 'none'; err.textContent = '';
      const type = paymentType.value;
      dyn.innerHTML = '';
      if(!type) return;

      if(type === 'upi'){
        dyn.innerHTML = `
          <label for="upiId">UPI ID</label>
          <input id="upiId" name="upiId" placeholder="username@bank" required />
        `;
      }
      else if(type === 'wallet'){
        dyn.innerHTML = `
          <label for="walletId">Wallet ID</label>
          <input id="walletId" name="walletId" placeholder="e.g., 98XXXXXX23" required />
        `;
      }
      else if(type === 'credit'){
        dyn.innerHTML = `
          <label for="nameOnCard">Name on Card</label>
          <input id="nameOnCard" name="nameOnCard" placeholder="Full Name" required />
          <label for="cardNumber">Card Number</label>
          <input id="cardNumber" name="cardNumber" inputmode="numeric" placeholder="4111 1111 1111 1111" maxlength="19" required />
          <div class="row">
            <div>
              <label for="expiry">Expiry (MM/YY)</label>
              <input id="expiry" name="expiry" placeholder="09/27" maxlength="5" required />
            </div>
            <div>
              <label for="cvv">CVV</label>
              <input id="cvv" name="cvv" inputmode="numeric" placeholder="123" maxlength="3" required />
            </div>
          </div>
        `;
        // small formatter for card input
        setTimeout(() => {
          const card = document.getElementById('cardNumber');
          card.addEventListener('input', () => {
            const digits = card.value.replace(/\D/g, '').slice(0,19);
            card.value = digits.replace(/(.{4})/g, '$1 ').trim();
          });
          const expiry = document.getElementById('expiry');
          expiry.addEventListener('input', () => {
            const d = expiry.value.replace(/\D/g, '').slice(0,4);
            expiry.value = d.length > 2 ? d.slice(0,2) + '/' + d.slice(2) : d;
          });
        }, 0);
      }
      // COD needs no extra fields
    }

    function onSubmit(e){
      e.preventDefault();
      out.textContent = '';
      err.style.display = 'none'; err.textContent = '';

      try{
        const fd = new FormData(form);
        const amount = fd.get('amount');
        const type = fd.get('paymentType');
        if(!type){ throw new Error('Please select a payment method'); }

        const payload = { amount };
        if(type === 'upi') payload.upiId = fd.get('upiId');
        if(type === 'wallet') payload.walletId = fd.get('walletId');
        if(type === 'credit') {
          payload.nameOnCard = fd.get('nameOnCard');
          payload.cardNumber = (fd.get('cardNumber')||'').replace(/\s+/g,'');
          payload.expiry = fd.get('expiry');
          payload.cvv = fd.get('cvv');
        }

        const payment = PaymentFactory.create(type, payload);
        console.log('[Factory] Created:', payment.constructor.name, payment);
        const result = payment.pay();
        console.log('[Payment] Result:', result);

        out.textContent = JSON.stringify({
          amount: Number(amount),
          ...result
        }, null, 2);

        if(result.status === 'failed'){
          err.textContent = result.message || 'Payment failed';
          err.style.display = 'block';
        }
      } catch(ex){
        console.error(ex);
        err.textContent = ex.message || 'Something went wrong';
        err.style.display = 'block';
      }
    }
  </script>
</body>
</html>